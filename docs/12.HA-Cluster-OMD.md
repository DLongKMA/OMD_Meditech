# Cấu hình Cluster cho check_mk - OMD

### Menu

- [1. Chuẩn bị](#1)
	- [Yêu cầu hệ thống](#11)
	- [Mô hình triển khai](#12)
	- [Bảng phân hoạch IP](#13)
- [2. Các bước cài đặt](#2)
	- [2.1 Đồng nhất thời gian giữa 2 server](#21)
	- [2.2 Cấu hình LVM cho ổ cứng mới gắn](#22)
	- [2.3 Cấu hình hostname](#23)
	- [2.4](#24)
	- [2.5](#25)
- [3. Tham khảo](#3)

<a name="1" />
	
## 1. Chuẩn bị

<a name="11" />
- **Yêu cầu hệ thống:**
	- Hệ điều hành CentOS 7
	- Mỗi server gắn thêm một ổ cứng 5GB
	- Mỗi server có 2 card mạng
	- Tắt Firewall và SELinux trên cả 2 server
	- Đồng nhất thời gian trên 2 server

<a name="12" />

- **Mô hình triển khai**

<img src="/images/HA-OMD-check_mk.png" width=70% />

<a name="13" />

- **Bảng phân hoạch IP cho các máy chủ**

<img src="/images/HA-omd-ip.png" />

Link Online: https://goo.gl/N8FFmz

- Chú thích:
	- Dải 192.168.100.0/24 phục vụ cho việc ra ngoài Internet
	- Dải 172.16.1.0/24 phục vụ cho việc đồng bộ dữ liệu giữa 2 server
	
<a name="2" />

## 2. Các bước cài đặt

<a name="21" />

### 2.1 Đồng nhất thời gian giữa 2 server

- Để cấu hình được cluster, chúng ta sẽ phải đồng nhất thời gian cho 2 server. Trên cả 2 server, chọn múi giờ `Asia/Ho_Chi_Minh` và cài gói `ntp` để đồng bộ thời gian.

```
timedatectl set-timezone Asia/Ho_Chi_Minh
yum install ntp -y
ntpdate pool.ntp.org
```

<a name="22" />

### 2.2 Cấu hình LVM trên 2 server

- Như liệt kê ở phần chuẩn bị, chúng ta gắn thêm một ổ cứng 5GB và cấu hình trên mỗi server.
- Trên cả 2 node, chúng ta tạo một LVM để lưu trữ các dữ liệu có tên là `/dev/vgdrbd/vol1`. Ở đây, /dev/sdb được sử dụng để tạo LVM.

```
[root@omd1 ~]# pvcreate /dev/sdb
  Physical volume "/dev/sdb" successfully created
[root@omd1 ~]# vgcreate vgdrbd /dev/sdb
  Volume group "vgdrbd" successfully created
[root@omd1 ~]# lvcreate -n vol1 -l100%FREE vgdrbd
  Logical volume "vol1" created.
```

<a name="23" />

### 2.3 Cấu hình hostname

Trước khi cài đặt, chúng ta phải cấu hình hostname cho mỗi node và ghi chúng vào``hosts`.

- **Bước 1:** Cấu hình hostname

Trên server 1

```
[root@node1 ~] hostnamectl set-hostname omd1
```

Trên server 2

```
[root@node2 ~] hostnamectl set-hostname omd2
```

- **Bước 2:** Ghi thêm vào hosts của mỗi server

```
vi /etc/hosts
```

```
[...]
192.168.100.135 omd1
192.168.100.136 omd2
172.16.1.135 omddata1
172.16.1.136 omddata2
```

<a name="24" />

### 2.4 Cài đặt và cấu hình DRBD trên 2 server

- Cài đặt DRBD

	- Để cài đặt DRDB mới nhất, chúng ta thêm repo của DRDB (các thao tác này làm trên cả 2 node):

	```
	rpm -ivh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm
	```
	- Thêm Public key cho DRDB

	```
	rpm --import /etc/pki/rpm-gpg/RPM-GPG-KEY-elrepo.org
	```
	- Tiếp theo, chúng ta cài đặt DRDB lần lượt trên cả 2 node:

	```
	yum -y install drbd*-utils kmod-drbd*
	```

	- Nếu quá trình cài đặt trên không thành công hoặc xảy ra lỗi hãy chèn lại key và tiếp tục cài đặt:

	```
	rpm --import /etc/pki/rpm-gpg/*
	```

	- Kích hoạt DRDB trên cả 2 node

	```
	modprobe drbd
	```

	- Kiểm tra DRDB đã hoạt động hay chưa:

	```
	lsmod | grep drbd

	drbd                  405309  0
	libcrc32c              12644  2 xfs,drbd
	```

<a name="3" />